<UserControl
    x:Class="RedgifsDownloader.View.DownloadsView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:conv="clr-namespace:RedgifsDownloader.Presentation.Converter"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helpers="clr-namespace:RedgifsDownloader.Presentation.Helpers"
    xmlns:local="clr-namespace:RedgifsDownloader.View"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    d:DesignHeight="450"
    d:DesignWidth="300"
    mc:Ignorable="d">
    <UserControl.Resources>
        <conv:InverseBoolConverter x:Key="InverseBoolConverter" />
        <conv:BoolToModeConverter x:Key="BoolToModeConverter" />
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <Style x:Key="VideoThumbnailStyle" TargetType="Border">
            <Setter Property="Height" Value="150" />
            <Setter Property="Margin" Value="5" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Gray" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Cursor" Value="Hand" />
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                    <Setter Property="BorderBrush" Value="Blue" />
                    <Setter Property="BorderThickness" Value="3" />
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>
    <Grid Grid.Row="1" Margin="5">
        <Grid.RowDefinitions>
            <RowDefinition Height="auto" />
            <RowDefinition Height="1.5*" />
            <RowDefinition Height="5" />
            <RowDefinition Height="*" MinHeight="100" />
        </Grid.RowDefinitions>
        <Grid Grid.Row="0" Margin="0,0,0,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="auto" />
                <ColumnDefinition Width="auto" />
                <ColumnDefinition Width="auto" />
            </Grid.ColumnDefinitions>
            <TextBlock
                Grid.Column="0"
                VerticalAlignment="Center"
                Text="User:" />
            <TextBox
                x:Name="UserBox"
                Grid.Column="1"
                Margin="5,0,0,0"
                VerticalContentAlignment="Center"
                KeyDown="UserBox_KeyDown"
                Text="{Binding Username, UpdateSourceTrigger=PropertyChanged}" />
            <ComboBox
                Grid.Column="2"
                Width="70"
                Margin="5,0,0,0"
                ItemsSource="{Binding Platforms}"
                SelectedItem="{Binding SelectedPlatform}" />
            <ToggleButton
                Grid.Column="3"
                MinWidth="50"
                Margin="5,0,0,0"
                IsChecked="{Binding IsAdvancedMode, Mode=TwoWay}">
                <ToggleButton.Content>
                    <TextBlock Text="{Binding IsAdvancedMode, Converter={StaticResource BoolToModeConverter}}" />
                </ToggleButton.Content>
            </ToggleButton>
            <Button
                x:Name="BtnCrawl"
                Grid.Column="4"
                MinWidth="70"
                Margin="5,0,0,0"
                HorizontalAlignment="Right"
                Command="{Binding CrawlCommand}"
                Content="{Binding CrawlBtnText}"
                IsEnabled="{Binding IsCrawling, Converter={StaticResource InverseBoolConverter}}" />
        </Grid>
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <Grid Grid.Row="0" Margin="0,0,0,5">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsAdvancedMode}" Value="True">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <CheckBox
                    Grid.Column="0"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    Command="{Binding SelectAllCommand}"
                    CommandParameter="{Binding IsChecked, RelativeSource={RelativeSource Self}}"
                    Content="全选"
                    IsChecked="{Binding IsAllSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                <Button
                    Grid.Column="1"
                    MinWidth="60"
                    Margin="5,0,0,0"
                    Command="{Binding DeselectAllCommand}"
                    Content="取消全选" />
                <Button
                    Grid.Column="2"
                    MinWidth="50"
                    Margin="10,0,0,0"
                    Command="{Binding SortByNameCommand}"
                    Content="{Binding SortByNameBtnText}" />
                <Button
                    Grid.Column="3"
                    MinWidth="50"
                    Margin="5,0,0,0"
                    Command="{Binding SortByDateCommand}"
                    Content="{Binding SortByDateBtnText}" />
                <CheckBox
                    Grid.Column="4"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center"
                    Content="显示标题"
                    IsChecked="{Binding IsCaptionVisible, Mode=TwoWay}" />
            </Grid>
            <!--  简单版和高级版互斥切换  -->
            <Grid Grid.Row="1">
                <!--  简单版：ListView  -->
                <ListView
                    x:Name="ListViewResults"
                    MinHeight="120"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    GridViewColumnHeader.Click="GridViewColumnHeader_Click"
                    ItemsSource="{Binding ActiveVideosView}"
                    MouseDoubleClick="ListView_MouseDoubleClick"
                    SelectionMode="Extended"
                    SizeChanged="ListView_SizeChanged"
                    Tag="Active">
                    <ListView.Style>
                        <Style TargetType="ListView">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsAdvancedMode}" Value="False">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ListView.Style>
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Width="30">
                                <GridViewColumn.Header>
                                    <CheckBox
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Command="{Binding SelectAllCommand}"
                                        CommandParameter="{Binding IsChecked, RelativeSource={RelativeSource Self}}"
                                        IsChecked="{Binding IsAllSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" />
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn
                                Width="130"
                                DisplayMemberBinding="{Binding Id}"
                                Header="Title" />
                            <GridViewColumn Width="65" DisplayMemberBinding="{Binding DisplayCreateDate}">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="日期" Tag="SortCreateDate" />
                                </GridViewColumn.Header>
                            </GridViewColumn>
                            <GridViewColumn
                                Width="50"
                                DisplayMemberBinding="{Binding DisplayStatus}"
                                Header="状态" />
                        </GridView>
                    </ListView.View>
                </ListView>
                <!--  高级版：缩略图网格  -->
                <Border BorderBrush="Gray" BorderThickness="1">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsAdvancedMode}" Value="True">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <ScrollViewer
                        x:Name="ThumbnailScrollViewer"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        HorizontalScrollBarVisibility="Disabled"
                        MouseLeave="ScrollViewer_MouseLeave"
                        PreviewMouseLeftButtonUp="ScrollViewer_PreviewMouseLeftButtonUp"
                        PreviewMouseMove="ScrollViewer_PreviewMouseMove"
                        SizeChanged="ScrollViewer_Thumbnail_SizeChanged"
                        VerticalScrollBarVisibility="Auto">
                        <ItemsControl
                            x:Name="ThumbnailItemsControl"
                            VerticalAlignment="Top"
                            Tag="Active">
                            <ItemsControl.Style>
                                <Style TargetType="ItemsControl">
                                    <Setter Property="ItemsSource" Value="{Binding ActiveVideosView}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsAdvancedMode}" Value="False">
                                            <Setter Property="ItemsSource" Value="{x:Null}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ItemsControl.Style>
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid Columns="{Binding Path=ThumbnailColumns, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border MouseLeftButtonDown="Thumbnail_MouseLeftButtonDown" Style="{StaticResource VideoThumbnailStyle}">
                                        <Grid>
                                            <Image
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                helpers:ImageSourceBehavior.AsyncImageSource="{Binding ThumbnailUrl}"
                                                Stretch="UniformToFill">
                                                <Image.Style>
                                                    <Style TargetType="Image">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ThumbnailUrl}" Value="{x:Null}">
                                                                <Setter Property="Source" Value="pack://application:,,,/Resources/icon.ico" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Image.Style>
                                            </Image>
                                            <Grid VerticalAlignment="Bottom" Background="#55000000">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="auto" />
                                                    <RowDefinition Height="auto" />
                                                    <RowDefinition Height="auto" />
                                                </Grid.RowDefinitions>
                                                <TextBlock
                                                    Grid.Row="0"
                                                    Margin="3"
                                                    FontSize="10"
                                                    Foreground="White"
                                                    Text="{Binding Id}"
                                                    TextTrimming="CharacterEllipsis"
                                                    TextWrapping="Wrap"
                                                    Visibility="{Binding DataContext.IsCaptionVisible, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisibilityConverter}}" />
                                                <TextBlock
                                                    Grid.Row="1"
                                                    Margin="3,0"
                                                    FontSize="9"
                                                    Foreground="LightGray"
                                                    Text="{Binding DisplayCreateDate}"
                                                    Visibility="{Binding DataContext.IsCaptionVisible, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisibilityConverter}}" />
                                                <TextBlock
                                                    Grid.Row="2"
                                                    Margin="3,0,3,3"
                                                    FontSize="9"
                                                    Foreground="LightGreen"
                                                    Text="{Binding DisplayStatus}" />
                                            </Grid>
                                            <CheckBox
                                                Grid.Row="0"
                                                Grid.RowSpan="2"
                                                Margin="5"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Top"
                                                Background="White"
                                                IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                Opacity="0.8" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>

            </Grid>
        </Grid>

        <!--  Splitter  -->
        <GridSplitter
            Grid.Row="2"
            Height="2"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Center"
            Background="Transparent"
            ShowsPreview="True" />
        <Grid Grid.Row="3" MinHeight="100">
            <Grid.RowDefinitions>
                <RowDefinition Height="auto" />
                <RowDefinition Height="auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <Grid
                Grid.Row="0"
                Height="20"
                Margin="0,0,0,15">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="auto" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="结果:" />
                <TextBlock Grid.Column="1" Text="{Binding VideosCount}" />
                <Button
                    x:Name="BtnOpenFolder"
                    Grid.Column="2"
                    Width="70"
                    HorizontalAlignment="Right"
                    Click="BtnOpenFolder_Click"
                    Content="D/L Folder" />
                <Button
                    x:Name="BtnDownload"
                    Grid.Column="3"
                    Width="70"
                    Margin="5,0,0,0"
                    HorizontalAlignment="Right"
                    Command="{Binding DownloadCommand}"
                    Content="{Binding DownloadBtnText}" />
                <Button
                    x:Name="BtnStop"
                    Grid.Column="4"
                    Width="35"
                    Margin="5,0,0,0"
                    HorizontalAlignment="Right"
                    Command="{Binding StopCommand}"
                    Content="停止" />
            </Grid>
            <Grid
                Grid.Row="1"
                Height="20"
                Margin="0,0,0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition />
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition />
                    <ColumnDefinition Width="auto" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="失败:" />
                <TextBlock
                    x:Name="TxtFailedCount"
                    Grid.Column="1"
                    Text="{Binding FailedCount}" />
                <TextBlock Grid.Column="2" Text="已下载:" />
                <TextBlock
                    x:Name="TxtDownloadedCount"
                    Grid.Column="3"
                    Text="{Binding CompletedCount}" />
                <Button
                    x:Name="BtnRetryAll"
                    Grid.Column="4"
                    Width="70"
                    HorizontalAlignment="Right"
                    Command="{Binding RetryAllCommand}"
                    Content="全部重试" />
            </Grid>
            <ListView
                x:Name="ListViewFailed"
                Grid.Row="2"
                MinHeight="50"
                GridViewColumnHeader.Click="GridViewColumnHeader_Click"
                ItemsSource="{Binding FailedVideosView}"
                MouseDoubleClick="ListView_MouseDoubleClick"
                SizeChanged="ListView_SizeChanged"
                Tag="Failed">
                <ListView.View>
                    <GridView>
                        <GridViewColumn
                            Width="210"
                            DisplayMemberBinding="{Binding Id}"
                            Header="Title" />
                        <GridViewColumn
                            Width="60"
                            DisplayMemberBinding="{Binding DisplayStatus}"
                            Header="状态" />
                    </GridView>
                </ListView.View>
            </ListView>
        </Grid>

    </Grid>
</UserControl>
